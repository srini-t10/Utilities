## MS SQL Utility - Generate Queryplan XML for the given SQL Query from given Server & Database

### Introduction:

MS SQL converts any SQL query into Queryplan before passing it to SQL engine. We can save these Queryplans as XML and we can extract the Tables/Columns used in the query from this XML. 
This utility applies the below method to generate Queryplan XMLs and save it in a folder. 

* Pass the list of SQL queries with ServerName, DatabaseName and Target Table/View/Query Name as input, to the script_generateBatchFileCommands.sql present in this folder.

* The script_generateBatchFileCommands.sql will generate the batch file commands for createSQLFiles.bat and createXMLFiles.bat

* createSQLFiles.bat will generate SQL File for each SQL query given as input. The SQL file content will be prefixed and suffied with "SET SHOWPLAN_XML" ON/OFF statements, to get the Queryplan.

* createXMLFiles.bat will call the SQLCMD commands to fetch Queryplan XML for SQLFiles and store the resulting XMLs in QueryplanXML folder.


### Objects:

This utility has following objects in folder and a short description about them.


| File Name | Type | Description |
| --- | --- | --- |
| QueryplanXML | Folder | The output MS SQL Queryplan XMLs from executing createXMLFiles.bat file will be placed in this folder. The XML files names will be the target Table/View name given in script_generateBatchFileCommands.sql |
| SQLFiles | Folder | A SQL File for each input query will be generated by createSQLFiles.bat and placed in this folder. These SQL files will be called from SQLCMD by createXMLFiles.bat |
| createSQLFiles.bat | Windows Batch File | Batch script that will create SQL files in SQLFiles folder |
| createXMLFiles.bat | Windows Batch File | Batch script that will create MS SQL Queryplan XMLs from SQLFiles to QueryplanXML folder |
| readme.md | Markdown | Documentation |
| script_generateBatchFileCommands.sql | MS SQL Query File | MS SQL File to create commands for batch files createSQLFiles.bat and createXMLFiles.bat |


### How to run this utility:

Following are the steps to run this utility,

1. Download and place all the objects from this utility in a single folder.

2. Edit script_generateBatchFileCommands.sql file and provide the list of SQL queries with ServerName, DatabaseName and Target Table/View/Query Name as input.

3. Run the script_generateBatchFileCommands.sql by connecting to a SQL server. It will return a table as output with following columns (data given is sample).

	| TableName | SQLQuery | SQLCmd_BuildSQLFile | SQMCmd_RunSQL |
	| --- | --- | --- | --- |
	| report.vwAttribute | SELECT * FROM report.vwAttribute | (echo SET NOCOUNT ON;     && echo GO    && echo:    && echo SET SHOWPLAN_XML ON;     && echo GO    && echo:    && echo SELECT * FROM report.vwAttribute;     && echo GO     && echo:    && echo SET SHOWPLAN_XML OFF;     && echo GO    && echo:)    > SQLFiles\report.vwAttribute.sql | sqlcmd -S ESVMUnityDev1 -d dbRKS -i SQLFiles\report.vwAttribute.sql -y0 -o QueryplanXML\report.vwAttribute.xml |
	| report.vwAttributeMap | SELECT * FROM report.vwAttributeMap | (echo SET NOCOUNT ON;     && echo GO    && echo:    && echo SET SHOWPLAN_XML ON;     && echo GO    && echo:    && echo SELECT * FROM report.vwAttributeMap;     && echo GO     && echo:    && echo SET SHOWPLAN_XML OFF;     && echo GO    && echo:)    > SQLFiles\report.vwAttributeMap.sql | sqlcmd -S ESVMUnityDev1 -d dbRKS -i SQLFiles\report.vwAttributeMap.sql -y0 -o QueryplanXML\report.vwAttributeMap.xml |
	| report.vwReport | SELECT * FROM report.vwReport | (echo SET NOCOUNT ON;     && echo GO    && echo:    && echo SET SHOWPLAN_XML ON;     && echo GO    && echo:    && echo SELECT * FROM report.vwReport;     && echo GO     && echo:    && echo SET SHOWPLAN_XML OFF;     && echo GO    && echo:)    > SQLFiles\report.vwReport.sql | sqlcmd -S ESVMUnityDev1 -d dbRKS -i SQLFiles\report.vwReport.sql -y0 -o QueryplanXML\report.vwReport.xml |

4. Copy the values from SQLCmd_BuildSQLFile column (from above table) to createSQLFiles.bat, and Copy the values from SQMCmd_RunSQL column (from above table) to createXMLFiles.bat

5. Run createSQLFiles.bat to generate SQLFiles

6. Once above step is done, Run createXMLFiles.bat to generate QueryplanXML


### Note:

This utility will serve as an example for following tasks,

* Write and execute Dynamic MSSQL query

* How to create SQL files by running a Windows Batch Script

* How to extract Queryplan XML for given SQL query

* How to run SQL Files from SQLCMD and sotre the output in a file


